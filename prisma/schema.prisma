generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  passwordHash   String
  name           String?
  phone          String    @unique
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  role           UserRole  @default(CUSTOMER)
  isActive       Boolean   @default(true)
  addresses      Address[]
  assignedOrders Order[]   @relation("DeliveryAgent")
  orders         Order[]
}

model OtpVerification {
  id        String   @id @default(cuid())
  phone     String
  otp       String
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone])
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  label      String?
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String
  country    String   @default("IN")
  lat        Float?
  lng        Float?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Product {
  id            String   @id @default(cuid())
  nameTa        String
  nameEn        String
  slug          String   @unique
  descriptionTa String?
  descriptionEn String?
  imageUrl      String?
  pricePaisa    Int      // price in paise
  unit          String   // e.g., "500ml", "1L"
  inStock       Boolean  @default(true)
  stockQuantity Int      @default(0) // inventory count for admin
  discount      Int      @default(0) // percentage discount (0-100)
  offerTextTa   String?  // special offer text in Tamil
  offerTextEn   String?  // special offer text in English
  category      String?  // product category (e.g., "Oils", "Ghee")
  sku           String?  @unique // stock keeping unit
  isActive      Boolean  @default(true) // show/hide product on store
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Order {
  id             String         @id @default(cuid())
  userId         String?
  status         OrderStatus    @default(PENDING)
  deliveryStatus DeliveryStatus @default(PENDING)
  assignedToId   String?
  paymentMethod  PaymentMethod  @default(COD)
  paymentStatus  PaymentStatus  @default(PENDING)
  totalPaisa     Int
  // Delivery details
  customerName   String?
  customerPhone  String?
  addressLine1   String?
  addressLine2   String?
  city           String?
  state          String?
  postalCode     String?
  lat            Float?
  lng            Float?
  notes          String?
  deliveredAt    DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  // Relations
  assignedTo     User?          @relation("DeliveryAgent", fields: [assignedToId], references: [id])
  user           User?          @relation(fields: [userId], references: [id])
  items          OrderItem[]
}

model OrderItem {
  id          String  @id @default(cuid())
  orderId     String
  productId   String?
  productSlug String?
  productName String
  unit        String
  quantity    Int
  pricePaisa  Int
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

enum UserRole {
  ADMIN
  DELIVERY
  CUSTOMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELED
  ASSIGNED
  IN_TRANSIT
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
}

enum PaymentMethod {
  COD
  RAZORPAY
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}
